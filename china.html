<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>China</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/util.js"></script>
    <style>
        html, body {margin: 0}
        #container {width:1200px;height:800px;}
        #slider-container {position: fixed;right: 650px;top: 57px; color: #fff;}
        #slider-container .title {margin-left: -18px;margin-bottom: 14px;font-size: 16px;}
        #slider-container .slider {height: 400px;}
        #slider-container .ui-slider-handle {width: 55px;height: 1.6em;left: -23px;margin-top: -.8em;text-align: center;line-height: 1.6em; font-size: 12px;}
        #slider-container .control {margin-left: -7px;margin-right: 11px;cursor: pointer;}
        #nowDate {position: fixed;left: 0px; top: 55px; color: #fff; width: 1200px; text-align: center;}
        #logo {position: fixed; left: 1120px; top: 773px;}
        /*#logo {position: fixed; left: 590px; top: 85px;}*/
        #logo img {width: 20px; height: 20px; border-radius: 5px;}
    </style>
</head>
<body>
<div id="container"></div>
<div id="slider-container">
    <div class="title">时光鸡</div>
    <div id="slider" class="slider">
        <div class="ui-slider-handle"></div>
    </div>
    <img id="playBtn" class="control" src="images/play.svg" />
</div>
<div id="nowDate"></div>
<div id="logo"><img src="images/helloint.jpg"/></div>
<script>
    var myChart = echarts.init(document.getElementById('container'), 'dark');
    var dataUrl = './data/nhcTotal.json';
    var regions = [['北京', 'bj'], ['天津', 'tj'], ['河北', 'heb'], ['山西', 'sx'], ['内蒙古', 'nm'], ['辽宁', 'ln'], ['吉林', 'jl'], ['黑龙江', 'hlj'], ['上海', 'sh'], ['江苏', 'js'], ['浙江', 'zj'], ['安徽', 'ah'], ['福建', 'fj'], ['江西', 'jx'], ['山东', 'sd'], ['河南', 'hen'], ['湖北', 'hub'], ['湖南', 'hun'], ['广东', 'gd'], ['广西', 'gx'], ['海南', 'hn'], ['重庆', 'cq'], ['四川', 'sc'], ['贵州', 'gz'], ['云南', 'yn'], ['西藏', 'xz'], ['陕西', 'sax'], ['甘肃', 'gs'], ['青海', 'qh'], ['宁夏', 'nx'], ['新疆', 'xj'], ['兵团', 'bt'],];
    var chartData = []; // {name: "新疆", value: 500}
    var maxNum = 1000;
    var totalData = null;
    var lastDate = null;
    var currentDate = null;
    var timeMachineIntervalId = null;
    fetch(dataUrl).then(function (response) {
        return response.json()
    }).then(jsonData => {
        totalData = jsonData;
        lastDate = Object.keys(totalData)[0];
        currentDate = lastDate;
        initTimeMachine();
        renderUI();
    });
    var option = {
        title: {
            text: '全国新冠肺炎疫情情况',
            subtext: '信息来自国家卫生健康委员会官方网站',
            // sublink: 'http://www.nhc.gov.cn/xcs/yqtb/list_gzbd.shtml',
            left: 'center',
            textStyle: {
                color: '#fff'
            }
        },
        visualMap: {
            left: 'right',
            min: 0,
            max: maxNum,
            inRange: {
                color: [
                    '#ffffff',
                    '#fdc368',
                    '#ff0000'
                ]
            },
            calculable: true
        },
        tooltip: {
            trigger: 'item',
            showDelay: 0,
            transitionDuration: 0.2,
            formatter: '{b}<br/>{c}人 (确诊 + 无症状)'
        },
        series: [
            {
                name: '',
                type: 'map',
                map: 'china',  // 中国地图
                roam: true, // 滚动缩放
                itemStyle: {
                    areaColor: '#fff'  // 省份块的颜色
                },
                label: {
                    show: true
                },
                emphasis: {
                    label: {
                        show: true
                    }
                },
            }
        ]
    }

    function renderUI() {
        chartData = [];
        const currentData = totalData[currentDate];
        regions.forEach(regionData => {
            const num = currentData[regionData[1]][0] + currentData[regionData[1]][1];
            chartData.push({name: regionData[0], value: num});
        });
        option.series[0].data = chartData;
        myChart.setOption(option);
        $('#nowDate').text(currentDate);
    }
    function initTimeMachine() {
        const handle = $("#slider .ui-slider-handle");
        const startDate = new Date(Object.keys(totalData)[Object.keys(totalData).length - 1]);
        const endDate = new Date(lastDate);
        const diffTime = Math.abs(endDate - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        $("#slider").slider({
            orientation: "vertical",
            value: 0,
            min: -diffDays,
            max: 0,
            create: function () {
                var thatDate = getDateByOffset(lastDate, $(this).slider("value"));
                handle.text(formatDate(thatDate).split('年')[1]);
            },
            slide: function (event, ui) {
                var thatDate = getDateByOffset(lastDate, ui.value);
                handle.text(formatDate(thatDate).split('年')[1]);
                if (currentDate !== thatDate) {
                    currentDate = thatDate;
                    renderUI();
                }
            },
            change: function (event, ui) {
                var thatDate = getDateByOffset(lastDate, ui.value);
                handle.text(formatDate(thatDate).split('年')[1]);
                if (currentDate !== thatDate) {
                    currentDate = thatDate;
                    renderUI();
                }
            }
        });

        $('#playBtn').click(() => {
            if ($('#playBtn').attr('src') === 'images/play.svg') {
                $('#playBtn').attr('src', 'images/stop.svg');
                let val = $("#slider").slider('value');
                if (val === 0) val = -diffDays;
                timeMachineIntervalId = setInterval(() => {
                    $("#slider").slider('value', ++val);
                    if (val === 0) {
                        clearInterval(timeMachineIntervalId);
                        $('#playBtn').attr('src', 'images/play.svg');
                    }
                }, 200);
            } else {
                clearInterval(timeMachineIntervalId);
                $('#playBtn').attr('src', 'images/play.svg');
            }
        });
    }
    function getDateByOffset(date, dayOffset) {
        var thatDay = new Date(new Date(date).getTime() + dayOffset * 3600 * 24 * 1000);
        return parseDate(thatDay);
    }
</script>
</body>
</html>
