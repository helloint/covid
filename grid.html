<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>基础数据</title>
    <style>
        body {
            font-size: 12px;
        }
        table.dataTable td {
            text-align: center;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.12.0/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.0/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.2.3/css/fixedHeader.dataTables.min.css">
    <script src="https://cdn.datatables.net/fixedheader/3.2.3/js/dataTables.fixedHeader.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/4.1.0/css/fixedColumns.dataTables.min.css">
    <script src="https://cdn.datatables.net/fixedcolumns/4.1.0/js/dataTables.fixedColumns.min.js"></script>
    <script>
        var labels = {
            "date": "日期",
            // "link": "链接",
            "confirm": "确诊",
            "wzz": "无症状",
            "zhuangui": "转归",
            "confirm_bihuan": "隔离管控确诊",
            "wzz_bihuan": "隔离管控无症状",
            "death": "死亡新增",
            "curr_confirm": "在院治疗",
            "cured": "新增治愈",
            "total_cured": "累计治愈",
            "curr_heavy": "现有重症",
            "curr_cri": "现有危重",
            "total": "阳性",
            "confirm_shaicha": "风险排查确诊",
            "wzz_shaicha": "风险排查无症状",
            "bihuan": "隔离管控",
            "shaicha": "风险排查",
            "history_total_cured": "历史累计治愈",
            "confirm-wzz_percent": "确诊/无症状比例",
            "wzz-zhuangui_percent": "无症状转归比例",
            "total_confirm": "累计确诊",
            "total_wzz": "累计无症状",
            "total_zhuangui": "累积转归",
            "total_wzz_correct": "累积无症状（去除转归）",
            "total_death": "累计死亡",
        };
        var basicData = ['confirm', 'wzz', 'zhuangui', 'confirm_bihuan', 'wzz_bihuan', 'death', 'curr_confirm', 'cured', 'total_cured', 'curr_heavy', 'curr_cri', 'total', 'confirm_shaicha', 'wzz_shaicha', 'bihuan', 'shaicha'];
        var calcData = ['history_total_cured', 'confirm-wzz_percent', 'wzz-zhuangui_percent', 'total_confirm', 'total_wzz', 'total_zhuangui', 'total_wzz_correct', 'total_death'];
        function init() {
            fetch(`data/dailyTotal.json`)
                .then(response => response.json())
                .then(data => {
                    drawTable(processData(data));
                });
        }
        function processData(data) {
            var total_cured = 0,
                total_confirm = 0,
                total_wzz = 0,
                total_zhuangui = 0,
                total_death = 0;
            Object.entries(data.daily).forEach(([date, dailyData]) => {
                total_cured = total_cured + dailyData['cured'];
                dailyData['history_total_cured'] = total_cured + 385;
                dailyData['confirm-wzz_percent'] = parseInt(dailyData['confirm'] / dailyData['wzz'] * 10000, 10) / 100 + '%';
                dailyData['wzz-zhuangui_percent'] = parseInt(dailyData['zhuangui'] / dailyData['wzz'] * 10000, 10) / 100 + '%';
                total_confirm = total_confirm + dailyData['confirm'];
                dailyData['total_confirm'] = total_confirm;
                total_wzz = total_wzz + dailyData['wzz'];
                dailyData['total_wzz'] = total_wzz;
                total_zhuangui = total_zhuangui + dailyData['zhuangui'];
                dailyData['total_zhuangui'] = total_zhuangui;
                dailyData['total_wzz_correct'] = dailyData['total_wzz'] - dailyData['total_zhuangui'];
                total_death = total_death + dailyData['death'];
                dailyData['total_death'] = total_death;
            });
            return data;
        }
        function drawTable(data) {
            var html = `<table id="covidData" class="dataTable display cell-border compact hover nowrap row-border"><thead><tr>`;
            Object.entries(labels).forEach(([key, value]) => {
               html += `<th>${value}</th>`;
            });

            html += `</tr></thead><tbody>`;
            Object.entries(data.daily).forEach(([date, dailyData]) => {
                var row = `<tr>`;
                row += `<td>${date}</td>`;
                Object.entries(labels).forEach(([key, chnName]) => {
                    if (key === 'date') return true;
                    row += `<td>${dailyData[key] !== undefined ? dailyData[key] : 'n/a'}</td>`;
                });
                row += `</tr>`;
                html += row;
            });
            html += `</tbody></table>`;
            $('#container').html(html);
            $('#covidData').DataTable({
                fixedHeader: true,
                fixedColumns: true,
                paging: false,
                searching: false,
                ordering:  false,
            });
        }
    </script>
</head>
<body onload="init()">
<div id="container"></div>
</body>
</html>